name: Auto Release Latest

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build
        run: npm run build

      - name: Create ZIP
        run: |
          cd dist
          zip -r ../wordgym-dist.zip .
          cd ..

      - name: Get version info
        id: version
        run: |
          echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create Versioned Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.date }}-${{ steps.version.outputs.short_sha }}
          name: "Build ${{ steps.version.outputs.date }} (${{ steps.version.outputs.short_sha }})"
          body: |
            ğŸ“¦ **ç‰ˆæœ¬è³‡è¨Š**

            - ğŸ“… å»ºç«‹æ™‚é–“: ${{ steps.version.outputs.timestamp }}
            - ğŸ“ Commit: ${{ github.sha }}
            - ğŸ’¬ è¨Šæ¯: ${{ github.event.head_commit.message }}

            **ä¸‹è¼‰æ–¹å¼ï¼š**
            ä¸‹è¼‰ `wordgym-dist.zip`ï¼Œè§£å£“å¾Œä¸Šå‚³åˆ° GCSã€‚
          files: wordgym-dist.zip
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Latest Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build"
          body: |
            ğŸš€ **æœ€æ–°ç‰ˆæœ¬** (è‡ªå‹•æ›´æ–°)

            - ğŸ“… æ›´æ–°æ™‚é–“: ${{ steps.version.outputs.timestamp }}
            - ğŸ“ Commit: ${{ github.sha }}
            - ğŸ·ï¸ ç‰ˆæœ¬: v${{ steps.version.outputs.date }}-${{ steps.version.outputs.short_sha }}

            **ä¸‹è¼‰æ–¹å¼ï¼š**
            ä¸‹è¼‰ `wordgym-dist.zip`ï¼Œè§£å£“å¾Œä¸Šå‚³åˆ° GCSã€‚

            ---
            ğŸ’¡ å¦‚éœ€ä¸‹è¼‰èˆŠç‰ˆæœ¬ï¼Œè«‹åˆ° [Releases åˆ—è¡¨](https://github.com/Youngger9765/WordGym-students-merge/releases) æŸ¥çœ‹æ­·å²ç‰ˆæœ¬ã€‚
          files: wordgym-dist.zip
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old releases (keep latest 10)
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 10
          delete_tags: true
          delete_tag_pattern: "^v[0-9]"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
