name: Deploy to GCS Bucket

on:
  # Option C: è‡ªå‹•è§¸ç™¼ (push to main)
  push:
    branches: [main]
  # Option C: æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      confirm:
        description: 'ç¢ºèªéƒ¨ç½²åˆ° GCS'
        required: true
        default: 'yes'

concurrency:
  group: "gcs-deploy"
  cancel-in-progress: false

jobs:
  deploy-to-gcs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS Bucket
        run: |
          # ä¸Šå‚³ dist å…§å®¹åˆ° GCS
          gsutil -m rsync -r -d ./dist gs://jutor-event-di1dzdgl64/event/wordgym

          # è¨­å®š Cache-Controlï¼ˆHTML ä¸å¿«å–ï¼Œå…¶ä»–è³‡æºå¿«å– 1 å¤©ï¼‰
          gsutil -m setmeta -h "Cache-Control:no-cache, no-store, must-revalidate" \
            "gs://jutor-event-di1dzdgl64/event/wordgym/*.html"
          gsutil -m setmeta -h "Cache-Control:public, max-age=86400" \
            "gs://jutor-event-di1dzdgl64/event/wordgym/assets/*"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ GCS éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Bucket**: jutor-event-di1dzdgl64" >> $GITHUB_STEP_SUMMARY
          echo "- **è·¯å¾‘**: event/wordgym" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¸ç™¼æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
